"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const graphql_1 = require("graphql");
const utils_1 = require("../../utils");
exports.providesNotOnEntity = (schema) => {
    const errors = [];
    const types = schema.getTypeMap();
    for (const [typeName, namedType] of Object.entries(types)) {
        if (!graphql_1.isObjectType(namedType))
            continue;
        for (const [fieldName, field] of Object.entries(namedType.getFields())) {
            const serviceName = field.federation && field.federation.serviceName;
            if (!serviceName)
                continue;
            if (field.federation && field.federation.provides) {
                if (!graphql_1.isObjectType(field.type)) {
                    errors.push(utils_1.errorWithCode('PROVIDES_NOT_ON_ENTITY', utils_1.logServiceAndType(serviceName, typeName, fieldName) +
                        `uses the @provides directive but \`${typeName}.${fieldName}\` returns \`${field.type}\`, which is not an Object type. @provides can only be used on Object types with at least one @key.`));
                    continue;
                }
                const fieldType = types[field.type.name];
                const selectedFieldIsEntity = fieldType.federation && fieldType.federation.keys;
                if (!selectedFieldIsEntity) {
                    errors.push(utils_1.errorWithCode('PROVIDES_NOT_ON_ENTITY', utils_1.logServiceAndType(serviceName, typeName, fieldName) +
                        `uses the @provides directive but \`${typeName}.${fieldName}\` does not return a type that has a @key. Try adding a @key to the \`${field.type}\` type.`));
                }
            }
        }
    }
    return errors;
};
//# sourceMappingURL=providesNotOnEntity.js.map